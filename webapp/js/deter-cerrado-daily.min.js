var graph={rawData:[],alertsCrossFilter:{},config:{},selectedFilters:{},dateFilterRange:null,dimensions:{},ctlFirstLoading:!1,totalizedAreaInfoBox:void 0,totalizedAlertsInfoBox:void 0,lineDistributionByMonth:void 0,histTopByCounties:void 0,ringTotalizedByState:void 0,histTopByUCs:void 0,histogramColor:["#0000FF","#57B4F0"],pallet:["#FF0000","#FF6A00","#FF8C00","#FFA500","#FFD700","#FFFF00","#DA70D6","#BA55D3","#7B68EE"],barTop10Color:"#b8b8b8",setConfigurations:function(a){a?(graph.pallet=a.pallet?a.pallet:graph.pallet,graph.histogramColor=a.histogramColor?a.histogramColor:graph.histogramColor,graph.barTop10Color=a.barTop10Color?a.barTop10Color:graph.barTop10Color,graph.defaultHeight=a.defaultHeight?a.defaultHeight:utils.getDefaultHeight()):console.log("Didn't load config file. Using default options.")},init:function(b,a){if(a.length==0||a.exception!==void 0){this.displayWarning(!0);return}Lang.apply(),graph.setConfigurations(b.dataConfig),this.loadData(!1,a)&&(this.displayWaiting(!1),this.config=b,this.totalizedAlertsInfoBox=dc.numberDisplay("#numpolygons"),this.totalizedAreaInfoBox=dc.numberDisplay("#custom-classes"),this.lineDistributionByMonth=dc.barChart("#chart-line-by-month"),this.histTopByCounties=dc.rowChart("#chart-hist-top-counties"),this.ringTotalizedByState=dc.pieChart("#chart-ring-by-state"),this.histTopByUCs=dc.rowChart("#chart-hist-top-ucs"),graph.build(),SearchEngine.init(this.histTopByCounties,this.ringTotalizedByState,'modal-search'))},startLoadData:function(){var a=function(d){var b,a,c;utils.displayLoginExpiredMessage(),graph.displayWaiting(),b={defaultDataDimension:'area',resizeTimeout:0,minWidth:250,dataConfig:d},a=downloadCtrl.getFileDeliveryURL()+"/download/"+downloadCtrl.getProject()+"/all_daily",downloadCtrl.isLocalhost()&&(a="./data/deter-cerrado-daily.csv"),c=function(a){Lang.apply(),a?(graph.setUpdatedDate(),graph.init(b,a)):graph.displayWarning(!0)},d3.csv(a).header("Authorization","Bearer "+(typeof Authentication!='undefined'?Authentication.getToken():"")).get(function(a,b){a&&a.status==401&&typeof Authentication!='undefined'?(Authentication.logout(),Authentication.setExpiredToken(!0)):c(b)})};d3.json("./config/"+downloadCtrl.getProject()+"-daily.json",a)},setUpdatedDate:function(){let a=typeof Authentication!="undefined"&&Authentication.hasToken()?"last_date":"updated_date";var b=$(location).attr('origin')+"/geoserver/";let c=b+downloadCtrl.getProject()+"/wfs?SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAME="+a+"&OUTPUTFORMAT=application%2Fjson";d3.json(c,function(a){let b=a&&a.features[0].properties?new Date(a.features[0].properties.updated_date+'T21:00:00.000Z').toLocaleDateString(Lang.language):'?';d3.select("#updated_date").html(' '+b)})},displayWaitingChanges:function(a){a===void 0&&(a=!0),d3.select('#loading_data_info').style('display',a?'':'none'),d3.select('#info_container').style('display',a?'':'none')},displayWaiting:function(a){a===void 0&&(a=!0),d3.select('#charts-panel').style('display',a?'none':''),d3.select('#loading_data_info').style('display',!a?'none':''),d3.select('#info_container').style('display',!a?'none':''),d3.select('#panel_container').style('display',a?'none':''),d3.select('#warning_data_info').style('display','none'),d3.select('#radio-area').style('display',a?'none':''),d3.select('#radio-alerts').style('display',a?'none':'')},displayWarning:function(a){a===void 0&&(a=!0),document.getElementById("warning_data_info").style.display=a?'':'none',document.getElementById("warning_data_info").innerHTML='<h3><span id="txt8">'+Translation[Lang.language].txt8+'</span></h3>',document.getElementById("loading_data_info").style.display=a?'none':''},loadData:function(a,b){return a?(console.log(a),!1):(graph.rawData=b,graph.normalizeData(),!0)},onDateRangeChange:function(){graph.displayWaitingChanges(),window.setTimeout(()=>{let a=new Date(utils.datePicker.getStartDate()._d),b=new Date(utils.datePicker.getEndDate()._d);if(b-a<0)alert(Translation[Lang.language].invalidRange);else{let c=graph.setDateRangeOnDataset(a,b);c?graph.build():(alert(Translation[Lang.language].noData),graph.setDateRangeOnDataset(graph.dateFilterRange[0],graph.dateFilterRange[1]))}graph.displayWaitingChanges(!1)},100)},setDateRangeOnDataset(b,c){graph.dimensions.date.filterAll();let a=new Date(c);return!(a.setDate(a.getDate()+1),graph.dimensions.date.filterRange([Date.parse(b),Date.parse(a)]),graph.dimensions.date.top(1).length==0)&&(graph.dateFilterRange=[b,c],!0)},setDataDimension:function(a){graph.displayWaitingChanges(),window.setTimeout(()=>{graph.config.defaultDataDimension=a,graph.storeSelectedFilter(),graph.resetFilters(),graph.onDateRangeChange(),graph.updateToSelectedFilter(),graph.displayWaitingChanges(!1)},100)},storeSelectedFilter:function(){graph.selectedFilters={},graph.histTopByCounties.hasFilter()&&(graph.selectedFilters.byCounty=graph.histTopByCounties.filters()),graph.lineDistributionByMonth.hasFilter()&&(graph.selectedFilters.byMonth=graph.lineDistributionByMonth.filters()),graph.ringTotalizedByState.hasFilter()&&(graph.selectedFilters.byState=graph.ringTotalizedByState.filters()),graph.histTopByUCs.hasFilter()&&(graph.selectedFilters.byUCs=graph.histTopByUCs.filters())},updateToSelectedFilter:function(){if(graph.selectedFilters.byCounty)while(graph.selectedFilters.byCounty.length)graph.histTopByCounties.filter(graph.selectedFilters.byCounty.pop());if(graph.selectedFilters.byState)while(graph.selectedFilters.byState.length)graph.ringTotalizedByState.filter(graph.selectedFilters.byState.pop());if(graph.selectedFilters.byUCs)while(graph.selectedFilters.byUCs.length)graph.histTopByUCs.filter(graph.selectedFilters.byUCs.pop());dc.redrawAll()},resetFilters:function(){graph.lineDistributionByMonth.filterAll(),graph.histTopByCounties.filterAll(),graph.ringTotalizedByState.filterAll(),graph.histTopByUCs.filterAll(),SearchEngine.applyCountyFilter()},resetLineDistributionByMonthFilter(){graph.lineDistributionByMonth&&graph.lineDistributionByMonth.hasFilter()&&graph.lineDistributionByMonth.filterAll(),graph.onDateRangeChange()},doResize:function(){graph.defaultHeight=utils.getDefaultHeight(),dc.renderAll()},normalizeData:function(){var b=d3.format('.2f'),a=[];this.rawData.forEach(function(c){var d={uf:c.h,county:c.i,codIbge:c.b},e;d.uc=c.j?c.j:'null',e=new Date(c.g+'T04:00:00.000Z'),d.timestamp=e.getTime(),d.areaKm=b(c.e)*1,d.areaUcKm=c.f?b(c.f)*1:0,a.push(d)}),this.rawData=a,delete a,this.initCrossFilter()},initCrossFilter:function(){this.alertsCrossFilter=crossfilter(this.rawData),this.dimensions.area=this.alertsCrossFilter.dimension(function(a){return a.areaKm}),this.dimensions.county=this.alertsCrossFilter.dimension(function(a){return a.county+"/"+a.uf}),this.dimensions.date=this.alertsCrossFilter.dimension(function(a){return a.timestamp}),this.dimensions.uf=this.alertsCrossFilter.dimension(function(a){return a.uf}),this.dimensions.uc=this.alertsCrossFilter.dimension(function(a){return a.uc+"/"+a.uf});let b=new Date(graph.dimensions.date.top(1)[0].timestamp),a=new Date(b),c=new Date(graph.dimensions.date.bottom(1)[0].timestamp);c.setHours(c.getHours()-1),a.setDate(a.getDate()-365),a.setHours(a.getHours()-6),utils.datePicker.setInterval(a,b),utils.datePicker.setStartMaxDate(b),utils.datePicker.setStartMinDate(c),utils.datePicker.setEndMaxDate(b),utils.datePicker.setEndMinDate(c),this.setDateRangeOnDataset(a,b)},build:function(){var c=graph.alertsCrossFilter.groupAll().reduce(function(a,b){return++a.n,a.tot+=b.areaKm,a},function(a,b){return--a.n,a.tot-=b.areaKm,a},function(){return{n:0,tot:0}}),d=graph.alertsCrossFilter.groupAll().reduce(function(a,b){return++a.n,a},function(a,b){return--a.n,a},function(){return{n:0}}),a=[],b;graph.config.defaultDataDimension=="area"?(a.county=graph.dimensions.county.group().reduceSum(function(a){return+a.areaKm}),a.uf=graph.dimensions.uf.group().reduceSum(function(a){return+a.areaKm}),a.date=graph.dimensions.date.group().reduceSum(function(a){return+a.areaKm}),a.uc=graph.dimensions.uc.group().reduceSum(function(a){return a.uc!='null'?+a.areaUcKm:0})):(a.county=graph.dimensions.county.group().reduceCount(function(a){return a.county}),a.uf=graph.dimensions.uf.group().reduceCount(function(a){return a.uf}),a.date=graph.dimensions.date.group().reduceCount(function(a){return+a.timestamp}),a.uc=graph.dimensions.uc.group().reduceSum(function(a){return a.uc!='null'?1:0})),b="<div class='icon-left'><i class='fa fa-leaf fa-2x' aria-hidden='true'></i></div><span class='number-display'>",this.totalizedAreaInfoBox.formatNumber(localeBR.numberFormat(',1f')),this.totalizedAreaInfoBox.valueAccessor(function(a){return a.n?a.tot.toFixed(2):0}).html({one:b+"<span>"+Translation[Lang.language].deforestation+"</span><br/><div class='numberinf'>%number km²</div></span>",some:b+"<span>"+Translation[Lang.language].deforestation+"</span><br/><div class='numberinf'>%number km²</div></span>",none:b+"<span>"+Translation[Lang.language].deforestation+"</span><br/><div class='numberinf'>0 km²</div></span>"}).group(c),this.totalizedAlertsInfoBox.formatNumber(localeBR.numberFormat(',')),this.totalizedAlertsInfoBox.valueAccessor(function(a){return a.n?a.n:0}).html({one:b+"<span>"+Translation[Lang.language].num_alerts+"</span><br/><div class='numberinf'>%number</div></span>",some:b+"<span>"+Translation[Lang.language].num_alerts+"</span><br/><div class='numberinf'>%number</div></span>",none:b+"<span>"+Translation[Lang.language].num_alerts+"</span><br/><div class='numberinf'>0</div></span>"}).group(d),this.buildCharts(a)},buildCharts:function(a){var d=graph.dimensions.date.top(1),h=graph.dimensions.date.bottom(1),e,f,c,g,k;utils.setTitle('timeline',Translation[Lang.language].timeline_header),e=new Date(d[0].timestamp),f=new Date(h[0].timestamp),c=localeBR.timeFormat('%d/%m/%Y'),g=d3.time.scale().domain([f,e]),k=graph.config.defaultDataDimension=='area'?utils.wildcardExchange("%Dim%")+" ("+utils.wildcardExchange("%unit%")+")":utils.wildcardExchange("%Unit%"),this.lineDistributionByMonth.height(310).margins({top:10,right:45,bottom:55,left:45}).yAxisLabel(k).dimension(graph.dimensions.date).group(a.date).transitionDuration(300).elasticY(!0).x(g).brushOn(!1).centerBar(!0).renderHorizontalGridLines(!0).renderVerticalGridLines(!0).colors(d3.scale.ordinal().range(['black']));let b=d3.time.months,i=utils.getNumberOfDaysForRangeDate(f,e);i<45?b=d3.time.days:i<90?b=d3.time.weeks:b=d3.time.months,this.lineDistributionByMonth.on('preRender',function(a){a.xUnits(d3.time.days).xAxis(d3.svg.axis().scale(g).orient("bottom").ticks(b).tickFormat(function(b){var c=b.toLocaleDateString(),d=b.toLocaleDateString().split("/");return a.effectiveWidth()<graph.config.minWidth?c=Translation[Lang.language].months_names[b.getMonth()]+"/"+d[2]:c=d[0]+"/"+Translation[Lang.language].months_names[b.getMonth()]+"/"+d[2],c})),a.yAxis().tickFormat(d3.format('.2s'))}),this.lineDistributionByMonth.on("renderlet.a",function(a){a.selectAll('g.x text').attr('transform','translate(-10,20) rotate(315)'),a.hasFilter()?($('#txt9a').css('display',''),$('#highlight-time').css('display','none')):($('#txt9a').css('display','none'),$('#highlight-time').css('display',''),$('#highlight-time').html(" "+c(new Date(h[0].timestamp))+" - "+c(new Date(d[0].timestamp))))}),this.lineDistributionByMonth.filterPrinter(function(a){let b=new Date(a[0][0]),d=a[0][0].toDateString(),e=new Date(a[0][1]).toDateString();return Date.parse(new Date(e))>Date.parse(new Date(d))?(b.setDate(b.getDate()+1)," "+c(b)+" - "+c(a[0][1])):" - "}),this.lineDistributionByMonth.title(function(a){return a.key!='empty'?new Date(a.key).toLocaleDateString()+': '+utils.numberByUnit(a.value)+utils.wildcardExchange(" %unit%"):Translation[Lang.language].without}),utils.setTitle('counties',Translation[Lang.language].title_top_county),this.histTopByCounties.height(graph.defaultHeight).dimension(graph.dimensions.county).group(utils.removeLittlestValues(a.county)).elasticX(!0).ordering(function(a){return a.county}).controlsUseVisibility(!0).ordinalColors([graph.barTop10Color]),this.histTopByCounties.on('preRender',function(a){a.height(graph.defaultHeight),a.xAxis().ticks(a.width()<graph.config.minWidth?5:6)}),this.histTopByCounties.on('preRedraw',function(a){a.data().length>5?a.fixedBarHeight(!1):a.fixedBarHeight(parseInt(a.effectiveHeight()*.7/10))}),this.histTopByCounties.on("renderlet.a",function(c){var d=c.selectAll('g.row text'),b=function(){var c=a.county.top(1/0),b={};return c.forEach(function(a,c){b['"'+a.key+'"']=c+1}),b};d[0].forEach(function(a){var c=b()['"'+a.innerHTML.split(":")[0]+'"']?b()['"'+a.innerHTML.split(":")[0]+'"']+'º - ':'';a.innerHTML=c+a.innerHTML})}),this.histTopByCounties.xAxis().tickFormat(function(a){return a+utils.wildcardExchange(" %unit%")}),this.histTopByCounties.data(function(a){var b=[];return b.push({key:Translation[Lang.language].without,value:0}),a.all().length>0?a.top(10):b}),this.histTopByCounties.title(function(a){return a.key+': '+utils.numberByUnit(a.value)+utils.wildcardExchange(" %unit%")}),this.histTopByCounties.label(function(a){return a.key+': '+utils.numberByUnit(a.value)+utils.wildcardExchange(" %unit%")}),utils.setTitle('state',Translation[Lang.language].title_tot_state),this.ringTotalizedByState.height(graph.defaultHeight).innerRadius(10).externalRadiusPadding(30).dimension(graph.dimensions.uf).group(utils.removeLittlestValues(a.uf)).ordering(dc.pluck('key')).ordinalColors(graph.pallet).legend(dc.legend().x(20).y(10).itemHeight(13).gap(7).horizontal(0).legendWidth(50).itemWidth(35)),this.ringTotalizedByState.on('preRender',function(a){a.height(graph.defaultHeight),a.legend().legendWidth(window.innerWidth/2)}),this.ringTotalizedByState.title(function(a){return a.key!='empty'?a.key+': '+utils.numberByUnit(a.value)+utils.wildcardExchange(" %unit%"):Translation[Lang.language].without}),this.ringTotalizedByState.renderLabel(!0).minAngleForLabel(.5),this.ringTotalizedByState.label(function(a){var b=a.key!='empty'?utils.numberByUnit(a.value)+utils.wildcardExchange(" %unit%"):Translation[Lang.language].without,c;return graph.ringTotalizedByState.hasFilter()?(c=graph.ringTotalizedByState.filters(),c.indexOf(a.key)>=0?b:''):b}),graph.ctlFirstLoading||dc.override(this.ringTotalizedByState,'legendables',function(){var a=this._legendables();return a.filter(function(a){return a.data>0})}),utils.setTitle('ucs',Translation[Lang.language].title_top_uc),this.histTopByUCs.height(graph.defaultHeight).dimension(graph.dimensions.uc).group(utils.removeLittlestValues(a.uc)).elasticX(!0).ordering(function(a){return a.uc}).controlsUseVisibility(!0).ordinalColors([graph.barTop10Color]),this.histTopByUCs.on('preRender',function(a){a.height(graph.defaultHeight),a.xAxis().ticks(a.width()<graph.config.minWidth?4:7)}),this.histTopByUCs.on('preRedraw',function(a){a.data().length>5?a.fixedBarHeight(!1):a.fixedBarHeight(parseInt(a.effectiveHeight()*.7/10))}),this.histTopByUCs.on("renderlet.a",function(c){var d=c.selectAll('g.row text'),b=function(){var c=a.uc.top(1/0),b={};return c.forEach(function(a,c){b['"'+a.key+'"']=c+1}),b};d[0].forEach(function(a){var c=b()['"'+a.innerHTML.split(":")[0]+'"']?b()['"'+a.innerHTML.split(":")[0]+'"']+'º - ':'';a.innerHTML=c+a.innerHTML})}),this.histTopByUCs.xAxis().tickFormat(function(a){return a+utils.wildcardExchange(" %unit%")}),this.histTopByUCs.data(function(a){var b=[];return b.push({key:Translation[Lang.language].without,value:0}),a.all().length>0?a.top(10):b}),this.histTopByUCs.title(function(a){return a.key+': '+utils.numberByUnit(a.value)+utils.wildcardExchange(" %unit%")}),this.histTopByUCs.label(function(a){return a.key+': '+utils.numberByUnit(a.value)+utils.wildcardExchange(" %unit%")});let j=function(a){utils.download=function(a){var b=new Blob([d3.csv.format(a)],{type:"text/csv;charset=utf-8"});saveAs(b,downloadCtrl.getProject()+'-daily-'+downloadCtrl.getDownloadTime()+'.csv')},window.setTimeout(function(){var b=[];a.forEach(function(a){var c={},d=new Date(a.timestamp);c.viewDate=d.toLocaleDateString(),c.areaMunKm=a.areaKm,c.areaUcKm=a.areaUcKm,c.uc=a.uc!='null'?a.uc:'',c.uf=a.uf,c.municipio=a.county,c.geocod=a.codIbge,a.areaKm&&b.push(c)}),utils.download(b)},200)};d3.select('#download-csv-daily-all').on('click',function(){let a=graph.rawData;j(a)}),d3.select('#download-csv-daily').on('click',function(){let a=graph.dimensions.uf.top(1/0);j(a)}),d3.select('#download-shp').on('click',function(){downloadCtrl.startDownload()}),d3.select('#prepare_print').on('click',function(){graph.preparePrint()}),graph.doResize(),window.onresize=utils.onResize,this.ctlFirstLoading=!0},preparePrint:function(){d3.select('#print_information').style('display','block'),d3.select('#print_page').on('click',function(){d3.select('#print_information').style('display','none'),window.print()})},configurePrintKeys:function(){Mousetrap.bind(['command+p','ctrl+p'],function(){return console.log('command p or control p is disabled'),!1})},restart(){graph.startLoadData()}};window.onload=function(){graph.configurePrintKeys(),utils.datePicker.initComponent(),Lang.init(),graph.startLoadData(),typeof Authentication!='undefined'&&(Authentication.serverURL='/oauth-api/',Authentication.init(Lang.language,function(){graph.resetFilters(),graph.restart()}))}